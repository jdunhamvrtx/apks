# Maintainer: Notebook Gallery Team <team@nb.gallery>
pkgname=octave
pkgver=4.2.0
pkgrel=0
pkgdesc="A high-level language, primarily intended for numerical computations."
url="http://www.octave.org"
arch="all"
license="GPL3"

depends="
	autoconf 
	automake 
	bison 
	curl 
	fftw-double-libs 
	fftw-long-double-libs 
	fftw-single-libs 
	gfortran 
	ghostscript 
	gnuplot 
	less 
	libltdl 
	perl 
	pkgconf 
	texinfo
	"
depends_dev="
	arpack-dev 
	fftw-dev 
	fltk-dev 
	fontconfig-dev 
	freetype-dev 
	ghostscript-dev 
	glu-dev 
	gl2ps-dev 
	glpk-dev 
	gnuplot 
	graphicsmagick-dev 
	hdf5-dev 
	imagemagick-dev 
	libltdl
	libsm-dev 
	libtool
	lcms2-dev 
	ncurses-dev
	pcre-dev 
	qhull-dev 
	qrupdate-dev 
	qscintilla-dev 
	qt-dev 
	readline-dev 
	suitesparse-dev 
	zlib-dev
	"

makedepends="$depends_dev"
install=""
subpackages="$pkgname-dev"
source="ftp://ftp.gnu.org/gnu/octave/octave-$pkgver.tar.gz
        ftp://ftp.gnu.org/gnu/octave/octave-$pkgver.tar.gz.sig
	abs.patch
	libinterp-deps.patch"

builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	local i
	cd "$builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
	find -name \*.cc -o -name \*.h -o -name \*.yy | xargs sed -i -e 's/#include <c\(math\|stdlib\)>/#include <\1.h>/'
	find -name \*.h -o -name \*.cc | xargs sed -i -e 's/<config.h>/"config.h"/' -e 's/<base-list.h>/"base-list.h"/'
}

build() {
	cd "$builddir"
	autoreconf -vfi
	export LDFLAGS="${LDFLAGS} -L/usr/lib"
	export CFLAGS="${CFLAGS} -I/usr/include"
	./configure --prefix=/usr --libexecdir=/usr/lib LIBS=-lz \
		--enable-shared --disable-static \
		--enable-jit \
		--with-umfpack="-lumfpack -lsuitesparseconfig" \
		--with-qhull="-lqhull" \
		--with-fft3-includedir=/usr/include \
		--with-fft3-libdir=/usr/lib \
		--disable-docs \
		--with-java-libdir=/usr/lib/jvm/java-1.8-openjdk/jre/lib/amd64/server
#		--with-quantum-depth=16 \
#		--disable-gui \
#		--disable-java
	
	echo "${PWD} is PWD"
	LANG=C make CFLAGS=-O CXXFLAGS=-O LDFLAGS= || return 1
	echo "Done with build..."
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install || return 1
	install -d "${pkgdir}/etc/ld.so.conf.d"
	rm "${pkgdir}"/usr/lib/charset.alias || return 1
	echo "/usr/lib/${pkgname}/${pkgver}" > "${pkgdir}/etc/ld.so.conf.d/${pkgname}.conf"
}

md5sums="4423db4dd6c2b43cacf9e9dcfa95473d  octave-4.2.0.tar.gz
0fa97871b3696943a29dc282a3221ffd  octave-4.2.0.tar.gz.sig
016d563eb6111c559aa8e65656f7dbc0  abs.patch
1f7f8e7f36c7550d561b7edfa88f10d2  libinterp-deps.patch"
sha256sums="443ba73782f3531c94bcf016f2f0362a58e186ddb8269af7dcce973562795567  octave-4.2.0.tar.gz
24e18e8545cd38f7f195e92cced2998d26f0bdb541c97b3235fee8455c232e6a  octave-4.2.0.tar.gz.sig
3e990698df8ce69f63ba5b80bce1924efe630a7ef71c47b8f39303d45a033ae0  abs.patch
f33a0f2ef8c1b1b0bac61c88a25d881990849b6f9810468229059af42d42c7fc  libinterp-deps.patch"
sha512sums="5d16665d4ef8f218320f471704f8702f3a2911cc4a083cae318c1df0f787d50dddbc511dc91e11379314d65cecac6d521abac026860feca19d11ffdb52d3e678  octave-4.2.0.tar.gz
7e12c38715253ca8f178a7820c23c31d7da5f7fc7b295d85798a0a46f6451d5a36dbc2e4f4a135f43f6fb58f96004eb644f0939889605a0c953bfda303dfe782  octave-4.2.0.tar.gz.sig
363a0072a43ddaf42527e224e249e7134026ee53c094817780816085f35be681db4e6d2210628efef0e52ab4963ff95d5b261560830beb9176f53a8a556c356c  abs.patch
b57adbf3af5cbf13806f862cbf02fdafa6d0d6ddb969d51c9368d660717f2a398ae3ad88de90b030867dd0acbaaf84153e5cce0d61cf4b7740be569f839a6809  libinterp-deps.patch"
