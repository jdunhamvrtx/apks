# Contributor: David Huffman <storedbox@outlook.com>
# Maintainer: David Huffman <storedbox@outlook.com>

pkgname=libtbb
pkgver=2017.7
_pkgverstr="2017_U7"
pkgrel=0
pkgdesc="IntelÂ® TBB, a widely used C++ template library for task parallelism"
url="https://threadingbuildingblocks.org"
arch="x86 x86_64"
license="GPL2"
subpackages="$pkgname-debug $pkgname-dev $pkgname-doc"
source="https://www.threadingbuildingblocks.org/sites/default/files/software_releases/source/${_pkgverstr}_src.tgz"
source="https://github.com/01org/tbb/archive/${_pkgverstr}.tar.gz"

_builddir="$srcdir/tbb-$_pkgverstr"
prepare() {
	local i
	cd "$_builddir"
	for i in "$startdir"/*; do
		case $i in
		*.patch) msg $i; patch --verbose -p1 -i $i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	make || return 1
}

_install_libs() {
	local buildtype libsuffix lib builddir
	buildtype="_$1"
	libsuffix="$2"
	lib="${3:-$subpkgdir}/usr/lib"
	builddir=$(find "$_builddir/build" -maxdepth 1 -name "*$buildtype" -type d) || return 1
	[ "$buildtype" != "_debug" ] && buildtype=''
	mkdir -p "$lib" || return 1
	mv "$builddir/libtbb${buildtype}.so$libsuffix" \
	   "$builddir/libtbbmalloc${buildtype}.so$libsuffix" \
	   "$builddir/libtbbmalloc_proxy${buildtype}.so$libsuffix" \
	   "$lib/" || return 1
}

package() {
	_install_libs release .2 "$pkgdir" || return 1
}

debug() {
	pkgdesc="$pkgdesc (debug symbols)"
	
	_install_libs debug .2 || return 1
}

dev() {
	pkgdesc="$pkgdesc (development files)"
	
	local prefix
	prefix="$subpkgdir/usr"
	cd "$_builddir"
	mkdir -p "$prefix" || return 1
	rm include/index.html && mv include "$prefix/" || return 1
	_install_libs release && _install_libs debug || return 1
}

doc() {
	arch="noarch"
	pkgdesc="$pkgdesc (documentation)"
	
	local share doc licenses
	share="$subpkgdir/usr/share"
	doc="$share/doc"
	licensesdir="$share/licenses/$pkgname"
	cd "$_builddir"
	mkdir -p "$doc" "$licensesdir" || return 1
	mv doc/ "$doc/$pkgname-$pkgver" || return 1
}

sha512sums="e4a6fcc3cace9b57061e8661b09af9cb2be721224889af52f4c1b4faec1a130512b7c960e21171ebb8105593a81bd9b80bef20cda91bfac174d535d0f7ccb680  2017_U7.tar.gz"
